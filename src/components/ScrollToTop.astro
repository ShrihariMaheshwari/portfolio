---
import { Icon } from 'astro-icon/components';
---

<button
  id="scroll-to-top"
  aria-label="Scroll to top"
  class="fixed bottom-4 right-4 z-50 
         backdrop-blur-sm
         bg-gray-800/70 dark:bg-gray-800/60
         p-2 sm:p-3 rounded-lg sm:rounded-xl
         text-gray-200
         opacity-0 invisible
         transform translate-y-4
         transition-all duration-300 ease-out
         hover:bg-gray-700/80 dark:hover:bg-gray-700/80
         hover:-translate-y-1 hover:scale-105
         shadow-md
         group
         sm:bottom-8 sm:right-8
         sm:hover:scale-110
         sm:shadow-lg sm:hover:shadow-xl
         sm:backdrop-blur-md"
>
  <div class="relative overflow-hidden rounded-lg">
    <Icon 
      name="mdi:chevron-up" 
      class="w-4 h-4 sm:w-6 sm:h-6 transition-transform duration-300 ease-out group-hover:-translate-y-0.5"
    />
  </div>
</button>

<script>
  interface ScrollButtonSetup {
    (): (() => void) | undefined;
  }

  const setupScrollButton: ScrollButtonSetup = () => {
    const scrollButton = document.getElementById('scroll-to-top');
    if (!scrollButton) return;

    let isAnimating = false;
    let lastScrollY = window.scrollY;
    let rafId: number;

    const toggleScrollButton = (): void => {
      if (!isAnimating) {
        isAnimating = true;
        rafId = window.requestAnimationFrame(() => {
          const shouldShow = window.scrollY > 200;
          const isScrollingUp = lastScrollY > window.scrollY;

          scrollButton.classList.toggle('opacity-0', !shouldShow);
          scrollButton.classList.toggle('invisible', !shouldShow);
          scrollButton.classList.toggle('translate-y-4', !shouldShow);
          scrollButton.classList.toggle('scale-95', !isScrollingUp);

          lastScrollY = window.scrollY;
          isAnimating = false;
        });
      }
    };

    const scrollToTop = (e: Event): void => {
      e.preventDefault();
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    };

    let timeout: ReturnType<typeof setTimeout>;
    const throttledScroll = () => {
      if (timeout) return;
      timeout = setTimeout(() => {
        toggleScrollButton();
        timeout = null;
      }, 100);
    };

    window.addEventListener('scroll', throttledScroll, { passive: true });
    scrollButton.addEventListener('click', scrollToTop);

    toggleScrollButton();

    return () => {
      window.removeEventListener('scroll', throttledScroll);
      scrollButton.removeEventListener('click', scrollToTop);
      clearTimeout(timeout);
      if (rafId) cancelAnimationFrame(rafId);
    };
  };

  let cleanup: (() => void) | undefined = setupScrollButton();

  document.addEventListener('astro:page-load', () => {
    if (cleanup) cleanup();
    cleanup = setupScrollButton();
  });
</script>

<style>
  #scroll-to-top {
    will-change: transform, opacity;
  }

  @media (prefers-reduced-motion: reduce) {
    #scroll-to-top {
      transition: none;
    }
    
    #scroll-to-top * {
      animation: none !important;
      transition: none !important;
    }
  }
</style>